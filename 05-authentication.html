<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head><body><h2 id="I5Authentication">I5: Authentication</h2><p>Authentication is an important part of almost any web application and there are several approache's to take. We will create one using a <code>filter</code>. <code>Filters</code> tell Wheels to run a function before an action is run or after an action has been run. You can also specify multiple functions and actions.</p><h3 id="CreatingaPeopletable">Creating a People table</h3><p>We will need a place to store users for authentication so lets create a migration for a people table.  You should be an old hat at this. Here is what the final migration for a People table should look like:</p><p><pre lang="cfm"><br/><code><br/><cfcomponent extends="plugins.dbmigrate.Migration" hint="creates people table"><br/>  <cffunction name="up"><br/>    <cfscript><br/>    t = createTable('people');<br/>    t.string('firstname');<br/>    t.string('lastname');<br/>    t.string('email');<br/>    t.string('password');<br/>    t.timestamps();<br/>    t.create();</p>   addRecord(table='people',id=1,email='admin@gmail.com',password='#Hash("admin")#');
    </cfscript>
  </cffunction>
  <cffunction name="down">
    <cfscript>
    dropTable('people');
    </cfscript>
  </cffunction>
</cfcomponent>
</code>
</pre><h3 id="CreatingthePersonModel">Creating the Person Model</h3><p>We will create a Model for our users called <code>Person.cfc</code>. It will validate several of our properties.</p><p><pre lang="cfm"><br/><code><br/><cfcomponent extends="Model" output="false"></p><cffunction name="init"> &lt;!-- Validations ---&gt;
  &lt;cfset validatesPresenceOf("firstName,lastName,email")&gt;
  &lt;cfset validatesFormatOf(property="email", type="email")&gt;
  &lt;cfset validatesLengthOf(property="firstName", maximum=30)&gt;
  &lt;cfset validatesLengthOf(property="lastName", maximum=50)&gt;
  &lt;cfset validatesConfirmationOf("password")&gt;</cffunction><p></cfcomponent><br/></code><br/></pre></p><h3 id="CreatingaLoginview">Creating a Login view</h3><p>Create a new folder and file <code>/views/main/login.cfm</code> with this code:</p><p><pre lang="cfm"><br/><code><br/><cfoutput></p><p><h1>Login</h1><br/>&lt;cfif isdefined("error")&gt;<br/> <cfdump var="#error#"><br/></cfif></p><p>#flash("error")#<br/>#errorMessagesFor("user")#</p><p>#startFormTag(controller="main", action="signin")#</p>#textField(label="Email", objectName="user", property="email")#
 #passwordField(label="Password", objectName="user", property="password")#<div>
  #submitTag(value="Sign In")#
 </div><p>#endFormTag()#</p><p></cfoutput><br/></code><br/></pre></p><p>Nothing special here. Lets try to load our login page at <code>http://wheels.local/index.cfm/main/login</code> If its there, you're ready to go!</p><h3 id="CreatingourMainController">Creating our Main Controller</h3><p>We will make a simple controller with the following actions: <code>login</code>, <code>logout</code>, and <code>signin</code>. The <code>signin</code> action creates a session structure called user if the email and password is correct.</p><p><pre lang="cfm"><br/><code><br/><cfcomponent extends="Controller" output="false"></p><cffunction name="init"></cffunction><cffunction name="login">
  &lt;cfset user = model("person").new()&gt;
 </cffunction><cffunction name="logout">
  &lt;cfset StructDelete(session, "user")&gt;
  &lt;cfset redirectTo(controller="main", action="login")&gt;
 </cffunction><cffunction name="signin">
  &lt;cfset user = model("person").findOne(where="email='#params.user.email#' AND password='#hash(params.user.password)#'")&gt; &lt;cfif IsObject(user)&gt;
   &lt;cfset session.user.id = user.id&gt;
   &lt;cfset redirectTo(controller="articles", action="index")&gt;
  <cfelse>
   &lt;cfset user = model("person").new(email=params.user.email)&gt;
   &lt;cfset flashInsert(error="The email and password that you entered is not valid.")&gt;
   &lt;cfset renderPage(action="login")&gt;
  </cfif>
 </cffunction><p></cfcomponent><br/></code><br/></pre></p><p>Now login with <b>admin@gmail.com</b> and <b>admin</b> and you should be directed to our listing page.</p><h3 id="SecuringOurApplication">Securing Our Application</h3><p>It looks like we can login, but we don't have a security check. Were just going to use one layer of security for the appa person who is logged in has access to all the commands and pages, while a person who isn't logged in can only post comments, view articles, and try to login.</p><p>Open the <code>/controllers/Controller.cfc</code> and add this code between the <code>cfcomponent</code> instructions:</p><p><pre lang="cfm"><br/><code><br/><cffunction name="checkLogin"><br/> &lt;cfif StructKeyExists(session, "user")&gt;<br/>  &lt;cfset loggedInUser = model("person").findByKey(session.user.id)&gt;<br/> <cfelse><br/>  &lt;cfset redirectTo(controller="main", action="login")&gt;<br/> </cfif><br/></cffunction><br/></code><br/></pre></p><p>You can add other functions to <code>/controllers/Controller.cfc</code> and make them globally available in all your controllers like we did for <code>checkLogin</code>.</p><p>Then we define an action to check if the person is logged in. If not, we redirect to the login page. If true this filter create a variable called LoggedInUser and then allow the requested action to be rendered.</p><p>The first thing we need to do is sprinkle <code>checkLogin</code> on most of our controllers:</p><ul><li>In <code>tags.cfc</code> , we don't have any actions that need to be protected.</li><li>In <code>comments.cfc</code> , we never implemented <code>index</code> and <code>delete</code> , but just in case we do lets allow unauthenticated users to only access</li><li>In <code>Articles.cfc</code> authentication should be required for <code>new</code> , <code>create</code> , <code>edit</code> , <code>update</code> and <code>delete</code>. Figure out how to write the before filter using either <code>only</code> or <code>except</code> </li></ul><p>Did you know how? If not here is the code to add the filters. In the <code>/controllers/Comments.cfc</code>:</p><p><pre lang="cfm"><br/><code><br/><cffunction name="init"><br/>		&lt;cfset filters(through="checkLogin", except="create")&gt;<br/>	</cffunction><br/></code><br/></pre></p><p>Next we add our filter to the <code>/controllers/Articles.cfc</code> in the <code>init</code> method.</p><p><pre lang="cfm"><br/><code><br/>&lt;cfset filters(through="checkLogin", only="new,create,edit,update,delete")&gt;<br/></code><br/></pre></p><p>This will run our <code>checkLogin</code> action in <code>/controllers/Controller.cfc</code> <em>before</em> these actions: <code>new</code>, <code>create</code>, <code>edit</code>, <code>update</code> and <code>delete</code>.</p><p>With that in place, try accessing <code>/article/new</code> when you logged in and when your logged out. </p><p>Now our app is pretty secure, but we should hide all those edit, delete, and new article links from unauthenticated users.</p><p>Open <code>/views/articles/index.cfm</code> and find the section where we output the Actions. Wrap that whole section in an <code>if</code> clause like this:</p><p><pre lang="cfm"><br/><code><br/>&lt;cfif StructKeyExists(session, "user")&gt;<br/>	<i>Actions:<br/>	#linkTo(text='edit', action='edit', key=id)#,<br/>	#linkTo(text='remove', action='delete', key=id, confirm="Remove the article '#title#'?")# <br/>	</i><br/></cfif><br/></code><br/></pre></p><p>Look at the article listing in your browser when you're logged out and make sure those links disappear. </p><h3 id="BetterNavigation">Better Navigation</h3><p>We still have to hide the Create a New Article link but the navigation has been bothering me. Let's try to clean it up a little more. Remove any cases of "&lt;&lt; Back to Articles List" and "Create a New Article". Then add this code to <code>/views/layout.cfm</code>.</p><p><pre lang="cfm"><br/><code><br/><div id="navbar"><br/> <ul><br/> &lt;cfif "show,edit,new,login" contains params.action &gt;<br/>  <li>#linkTo(text="&lt;&lt; Back to Articles List", controller="articles", action="index")#</li><br/> </cfif><br/> &lt;cfif StructKeyExists(session, "user")&gt;<br/>  <li>#linkTo(text="Create a New Article", action="new")#</li><br/>  <li>#linkTo(text="Logout", controller="main", action="logout")#</li><br/> &lt;cfelseif params.action NEQ "login"&gt;<br/>  <li>#linkTo(text="Login", controller="main", action="login")#</li><br/> </cfif><br/></ul><br/></div><br/></code><br/></pre></p><p>If you look at the <code>show</code> view template, you'll see that we never added an edit link! Let's quick add that link now, but protect it to only show up when a user is logged in and they are on the <code>article</code> controller and <code>show</code> action.</p><p><pre lang="cfm"><br/><code><br/>&lt;cfif params.controller EQ "articles" and params.action EQ "show"&gt;<br/><li>#linkTo(text='Edit Current Article', action='edit', key=params.key)#</li><br/></cfif><br/></code><br/></pre></p><p>Your basic authentication is done, and Iteration 5 is complete!</p></body></html>