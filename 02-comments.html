<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head><body><h2 id="I2.1AddingComments">I2.1: Adding Comments</h2><p>Most blogs allow the reader to interact with the content by posting comments. Let's add some simple comment functionality.</p><h3 id="DesigningtheCommentModel">Designing the Comment Model</h3><p>First, we need to brainstorm what a comment <em>is</em>...what kinds of data does it have...</p><ul><li>It's attached to an article</li><li>It has an author name</li><li>It usually has an author email address</li><li>It usually has an optional URL</li><li>It has a body</li></ul><p>With that understanding, let's create a Comment model. Switch over to Eclipse and right click on the models folder, then select New --&gt; File and enter "Comment.cfc" for File name. The file will be created and automatically open, then you can add this code to it:</p><p><pre lang="cfm"><br/><code><br/><cfcomponent extends="Model" output="false"><br/> <cffunction name="init"></p></cffunction>
</cfcomponent>
</code>
</pre><p>Pretty simple, huh?</p><h3 id="SettinguptheMigration">Setting up the Migration</h3><p>Open the <strong>DBMigrate</strong> plugin and fill it out with the following and click "create":</p><ul><li>Select template? Create table</li><li>Migration description: creates comments table</li></ul><p>Open the file that the generator created, <code>/db/migrate/some-timestamp_creates_comments_table.cfc</code>. Inside the <code>self.up</code> you need to add one line for each of the pieces of data we just brainstormed. It'll start off with these...</p><p><pre lang="cfm"><br/><code><br/>t.integer('articleid');<br/>t.string('authorname');<br/></code><br/></pre></p><p>Then keep adding lines creating strings named <code>authoremail</code>, <code>authorurl</code>, and a text field named <code>body</code>.</p><p>Once that's complete, go to the <strong>DBMigrate</strong> plugin and run the migration by clicking <code>go</code>.</p><h3 id="Relationships">Relationships</h3><p>The power of SQL databases is the ability to express relationships between elements of data. We can join together the information about an order with the information about a customer. Or in our case here, join together an article (in the articles table) with its comments (in the comments table). We do this by using foreign keys.</p><p>Foreign keys are a way of marking one-to-one and one-to-many relationships. An article might have zero, five, or one hundred comments. But a comment only belongs to one article. These objects have a one-to-many relationship - one article connects to many comments.</p><p>Part of the big deal with Wheels is it makes working with these relationships very easy. When we created the migration for comments we started with an <code>integer</code> field named <code>articleid</code>. The Wheels convention is, for a one-to-many relationship, the objects on the "many" end should have a foreign key referencing the "one" object. And the foreign key should be titled with the name of the "one" object, then "id". So in this case one article has many comments, so each comment has a field named <code>articleid</code> which tracks which article they belong to. Similarly, a store's customer might have many orders, so each order would have a <code>customerid</code> specifying which customer they belong to.</p><p>Following this convention will get us a lot of functionality "for free." Open your <code>/models/comment.cfc</code> and add the middle line so it looks like this:</p><p><pre lang="cfm"><br/><code><br/><cfcomponent extends="Model" output="false"></p><cffunction name="init">
  &lt;cfset belongsTo("article") /&gt;
 </cffunction><p></cfcomponent><br/></code><br/></pre></p><p>A comment relates to a single article, it "belongs to" an article. We then want to declare the other side of the relationship inside <code>/models/article.cfc</code> like this:</p><p><pre lang="cfm"><br/><code><br/><cffunction name="init"><br/> &lt;cfset hasMany("comments") /&gt;<br/></cffunction><br/></code><br/></pre></p><p>Wheels now know an article "has many" comments, and a comment "belongs to" an article. We have explained to Wheels these objects have a one-to-many relationship.</p><h3 id="TestinginExamples">Testing in Examples</h3><p>Let's use the <code>/controllers/Examples.cfc</code> to test how this relationship works in code. Open the <code>Examples.cfc</code> file and paste in the following instructions and observe the output at at <a href="http://wheels.local/index.cfm/Examples/three">http://wheels.local/index.cfm/Examples/three</a> :</p><p><pre lang="cfm"><br/><code><br/><cffunction name="three"><br/> &lt;cfset a = model("article").findByKey(key=3,<br/>  include="comments") /&gt;<br/> <cfdump var="#a.comments#" /><br/> &lt;cfdump var="#model("comment").new()#" /&gt;<br/> <cfdump var="#a.newComment()#" /><br/> <cfabort><br/></cffunction><br/></code><br/></pre></p><p>When you called the <code>comments</code> method on object <code>a</code>, it gave you back a blank array because that article doesn't have any comments. When you executed <code>model("comment").new()</code> it gave you back a blank Comment object. But, if you look closely, when you did <code>a.newComment()</code> the comment object you got back wasn't quite blank - it has the <code>articleid</code> field already filled in with the ID number of article <code>a</code>.</p><p>Try creating a few comments for that article like this:</p><p><pre lang="cfm"><br/><code><br/><cffunction name="four"><br/> &lt;cfset a = model("article").findByKey(key=3,include="comments") /&gt;</p>&lt;cfset c = a.newComment() /&gt;
 &lt;cfset c.authorname = "Daffy Duck" /&gt;
 &lt;cfset c.authorurl = "http://daffyduck.com" /&gt;
 &lt;cfset c.body = "I think this article is thhh-thhh-thupid!" /&gt;
 &lt;cfset c.save() /&gt;&lt;cfset d = a.createComment(authorname = "Chewbacca", body = "RAWR!") /&gt;
 <cfabort>
</cffunction>
</code>
</pre><p>For the first comment, <code>c</code>, I used a series of commands like we've done before. For the second comment, <code>d</code>, I used the <code>create</code> method. When you use <code>new</code> it doesn't go to the database until you call <code>save</code>. With <code>create</code> you usually pass in the attributes then the object is created, those attributes set, and the object saved to the database all in one step.</p><p>Now you've created a few comments, try executing <code>a.comments</code> again. </p><p><pre lang="cfm"><br/><code><br/><cffunction name="five"><br/> &lt;cfset a = model("article").findByKey(key=3,include="comments") /&gt;<br/> <cfdump var="#a.comments#" /><br/> <cfabort><br/></cffunction><br/></code><br/></pre></p><p>Did your comments all show up? Great. Now we need to integrate them into the article display.</p><h2 id="I2.1AddingCommentscontinued">I2.1: Adding Comments (continued)</h2><h3 id="DisplayingCommentsforanArticle">Displaying Comments for an Article</h3><p>We want to display any comments underneath their parent article. Because we've setup the relationships between those models, this is very easy. Open <code>/views/articles/show.cfm</code> and add the following lines right before the link to the articles list:</p><p><pre lang="cfm"><br/><code><br/><h3>Comments</h3><br/><cfoutput>#includePartial(article.comments)#</cfoutput><br/></code><br/></pre></p><p>This says we want to render a partial named "comment" and we want to do it once for each element in the collection <code>article.comments</code>. We saw in the Examples that when we call the <code>comments</code> method on an article we'll get back an array of it's associated comment objects. So this render line will pass each element of that array one at a time into the partial named "comment". Now we need to create the partial <code>/views/articles/_comment.cfm</code> and add this code:</p><p><pre lang="cfm"><br/><code><br/><cfoutput><br/><div class="comment"><br/>  <h4>Comment by #arguments.comment.authorname#</h4><br/>  <p>#arguments.comment.body#</p><br/></div><br/></cfoutput><br/></code><br/></pre></p><p>With that in place, try clicking on the articles and find the one where you created the comments. Did they show up? What happens when an article doesn't have any comments?</p><h3 id="WebBasedCommentCreation">Web-Based Comment Creation</h3><p>Good start, but our users (hopefully) can't get into the Examples code to create their comments. We'll need to create a web interface. We'll go through some of the same steps we did when creating the web interface for creating articles.</p><p>Let's start with the form. The comment form should be embedded into the article's <code>show</code> template. So let's add this code right above the "&lt;&lt; Back to Articles List" in the articles <code>show.cfm</code></p><p><pre lang="cfm"><br/><code><br/>#includePartial("comment_form")#<br/></code><br/></pre></p><p>Obviously this is expecting a file <code>/views/articles/_comment_form.cfm</code>, so create the file and add this content for now:</p><p><pre lang="cfm"><br/><code><br/><h3>Post a Comment</h3><br/><p>(Comment form will go here)</p><br/></code><br/></pre></p><p>Look at an article in your browser to make sure the partial is showing up. Then we can start figuring out the details of the form.</p><p>Ok, now look at your <code>Articles.cfc</code> in the <code>new</code> method. Remember how we had to create a blank Article object so Wheels could figure out which fields an article has? We need to do the same thing before we create a form for the comment. But when we view the article and display the comment form we're not running the article's <code>new</code> method, we're running the <code>show</code> method. So we'll need to create a blank Comment object inside that <code>show</code> method like this:</p><p><pre lang="cfm"><br/><code><br/>&lt;cfset comment = article.newComments() /&gt;<br/></code><br/></pre></p><p>This is just like we did it in the Examples. Now we can create a form inside our <code>_comment_form.cfm</code> partial like this:</p><p><pre lang="cfm"><br/><code><br/><h3>Post a Comment</h3><br/><cfoutput><br/> #errorMessagesFor("comment")#<br/> #startFormTag(controller="comments",action="create")#<br/>  #hiddenField(objectName='comment', property='articleid')#<br/>  #textField(objectName='comment', property='authorname')#<br/>  #textField(objectName='comment', property='authoremail')#<br/>  #textField(objectName='comment', property='authorurl')#<br/>  #textArea(objectName='comment', property='body')#<br/>  #submitTag(value="Create Comment")#<br/> #endFormTag()#<br/></cfoutput><br/></code><br/></pre></p><p>The only new thing here is the hidden field helper. This hidden field will hold the ID of the article to help when creating the comment object.</p><p>Save then refresh in your web browser and... well... you'll get an error like this:</p><p><pre lang="cfm"><br/>Wheels.ViewNotFound<br/>Could not find the view page for the create action in the Comments controller.</p><p>Suggested action</p><p>Create a file named create.cfm in the views/comments directory (create the directory as well if it doesn't already exist).<br/></pre></p><p>The <code>startFormTag</code> helper is trying to build the form so that it submits to <code>/comments/create</code>, but we haven't created the Comments controller yet.</p><h3 id="CreatingaCommentsController">Creating a Comments Controller</h3><p>Just like we needed an <code>Articles.cfc</code> to manipulate our Articles, we'll need a <code>Comments.cfc</code> to manipulate our Comments. Create it to add this code:</p><p><pre lang="cfm"><br/><code><br/><cfcomponent extends="Controller" output="false"></p><cffunction name="index">
 </cffunction><cffunction name="create">
 </cffunction><cffunction name="delete">
 </cffunction><p></cfcomponenet><br/></code><br/></pre></p><p>The first action we're interested in first is <code>create</code>. You can cheat by looking at the <code>create</code> method in your <code>Articles.cfc</code>. For your <code>Comments.cfc</code>, everything should be the same just replace article with comment. Then the <code>redirectTo</code> is a little different, use this:</p><p><pre lang="cfm"><br/><code><br/>&lt;cfset redirectTo(controller="article",action="index")&gt;<br/></code><br/></pre></p><p>Test out your form to create another comment now - and it should work!</p><h4 id="CommentValidation">Comment Validation</h4><p>During creating this training, I noticed a "bug" with the <code>renderPage</code> and <code>#includePartial(article.comments)#</code> combination. It seems <code>includePartial</code> used this way doesn't allow another controller to be called so, I copied <code>/views/articles/_comment.cfm</code> to <code>/views/comments</code>. This allows error messages to appear along with the form being populated again. Another fix could be to do a <code>redirectTo</code>. I also had to change the <code>redirectTo(back=true)</code> to <code>&lt;cfset redirectTo(controller="articles",action="show",key=comment.articleid</code> this way if an error happens, then a successful comment, we get back to the appropriate place.</p><h3 id="CleaningUp">Cleaning Up</h3><p>We've got some decent comment functionality, but there are a few things we should add and tweak.</p><h4 id="ValidationforArticlesandComments">Validation for Articles and Comments</h4><p>TODO: add section for validation of articles and comments</p><h4 id="FormLabels">Form Labels</h4><p>The comments form looks a little silly will all the inputs on one line and with "Authorname" and "Authorurl" and such. It should probably say "Your Name" and "Your URL (optional)", right? To change the text that the label helper prints out, you just pass in the desired text as a second parameter, like this:</p><p><pre lang="cfm"><br/><code><br/>#textArea(objectName='comment', property='authorname', label='Your Name')#<br/></code><br/></pre></p><p>Change your <code>_comment_form.cfm</code> so it prints out "Your Name", "Your Email Address", "Your URL (optional)", and "Your Comment". Then refresh the page and look at the html generated. It should look like this:</p><p><pre lang="cfm"><br/><code><br/><label for="comment-authorname">Your Name<input type="text" value="" name="comment[authorname]" maxlength="255" id="comment-authorname"></label><br/></code><br/></pre></p><p>Nicer, shouldn't the label be around "Author Name"? And we are still missing the wrapping <code>&lt;p&gt;</code> tag along with a <code>&lt;br&gt;</code> between the label and input. To accomplish this we will set some defaults for a our helper functions in <code>config/settings.cfm</code>. Open the file and add these lines:</p><p><pre lang="cfm"><br/><code><br/>&lt;cfset set(functionName="textField", labelPlacement='before', prependToLabel="<p>", prepend="<br>", append="</p>") /&gt;<br/>&lt;cfset set(functionName="textArea", labelPlacement='before', prependToLabel="<p>", prepend="<br>", append="</p>") /&gt;<br/></code><br/></pre></p><p>We are saying place the label before the input, and prepend <code>&lt;p&gt;</code> to the label, then prepend <code>&lt;br&gt;</code> to the input, and finally append <code>&lt;/p&gt;</code> to the input. Confused? Hopefully, not :-)</p><p>Refresh, and you should see html source like this:</p><p><pre lang="cfm"><br/><code><br/><p><br/> <label for="comment-authorname">Authorname</label><br><br/> <input type="text" value="" name="comment[authorname]" maxlength="255" id="comment-authorname"><br/></p><br/></code><br/></pre></p><h4 id="CommentsCount">Comments Count</h4><p>Let's make it so where the view template has the "Comments" header it displays how many comments there are, like "Comments ( 3 )". Open up your article's <code>show.cfm</code> and change the comments header so it looks like this:</p><p><pre lang="cfm"><br/><code><br/><h3>Comments ( #article.commentCount()# )</h3><br/></code><br/></pre></p><h4 id="AddTimestamptotheCommentDisplay">Add Timestamp to the Comment Display</h4><p>We should add something about when the comment was posted. Wheels has a really neat helper named <code>distanceOfTimeInWords</code> which takes two dates and creates a text description of their difference like "32 minutes later", "3 months later", and so on. You can use it in your <code>_comment.cfm</code> partial like this:</p><p><pre lang="cfm"><br/><code><br/><p>Posted #distanceOfTimeInWords(arguments.comment.createdat, now())# later</p><br/></code><br/></pre></p><p>With that, you're done with I2!</p></body></html>